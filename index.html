<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Allergy-World Headlines</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:1rem;line-height:1.45}
    h1{margin:0 0 1.25rem;font-size:1.75rem}
    #news-feed{max-width:780px;margin:0 auto}
    .item{display:grid;grid-template-columns:112px 1fr;gap:.9rem;margin-bottom:1rem;align-items:start}
    .item img{width:112px;height:112px;object-fit:cover;border-radius:8px;box-shadow:0 0 4px rgba(0,0,0,.15)}
    .item a{font-weight:600;text-decoration:none;color:#064}
    .item a:hover{text-decoration:underline}
    .item time{display:block;font-size:.8rem;color:#666;margin-top:.3rem}
  </style>
</head>
<body>

  <h1>Latest Allergy News</h1>
  <div id="news-feed"></div>

<script>
/* ————————————————— CONFIG ————————————————— */
const RSS_KEY  = 'nnzvu8zozr6k48xr7up6386y0xreoghpdp0evyfx';  // ← your rss2json key
const FEEDS    = [
  'https://www.fda.gov/about-fda/contact-fda/stay-informed/rss-feeds/food-allergies/rss.xml',
  'https://www.fda.gov/about-fda/contact-fda/stay-informed/rss-feeds/food-safety-recalls/rss.xml',
  'https://www.sciencedaily.com/rss/health_medicine/allergy.xml',
  'https://news.google.com/rss/search?q=allergy+OR+food+allergy&hl=en-US&gl=US&ceid=US:en'
];
const PLACEHOLDER = 'https://placehold.co/112x112?text=EPI';   // default square
const MAX_ITEMS   = 30;                                        // trim the river
const MICROLINK   = link => `https://api.microlink.io/?url=${encodeURIComponent(link)}&meta=true&audio=false&video=false`;

/* ————————————————— FETCH & MERGE ————————————————— */
(async () => {
  const rssUrl = u => `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(u)}&api_key=${RSS_KEY}&count=20`;
  const arrays = await Promise.allSettled(FEEDS.map(f => fetch(rssUrl(f)).then(r => r.json())));
  const items  = arrays
      .filter(r => r.status === 'fulfilled' && r.value.status === 'ok')
      .flatMap(r => r.value.items);

  // newest first
  items.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));

  // enrich with thumbs (feeds first → Microlink fallback)
  const enriched = await Promise.all(items.slice(0, MAX_ITEMS).map(async it => {
    let thumb = extractFeedImage(it);
    if (!thumb) {                         // fallback: one Microlink call per item
      try {
        const res  = await fetch(MICROLINK(it.link));
        const data = await res.json();
        thumb = data?.data?.image?.url || '';
      } catch(e) { /* ignore */ }
    }
    return { ...it, thumb: thumb || PLACEHOLDER };
  }));

  render(enriched);
})();

/* ————————————————— HELPERS ————————————————— */
function extractFeedImage(it){
  if (it.thumbnail)                                      return secure(it.thumbnail);
  if (it.enclosure && (it.enclosure.link||it.enclosure.url))
                                                        return secure(it.enclosure.link||it.enclosure.url);
  if (it['media:content'] && it['media:content'].url)   return secure(it['media:content'].url);
  const html = it.content || it.description || '';
  const m    = html.match(/<img[^>]+src=['"]([^'"]+)['"]/i);
  return m ? secure(m[1]) : '';
}
const secure = u => (u && u.startsWith('http://')) ? u.replace('http://','https://') : u;

/* ————————————————— RENDER ————————————————— */
function render(list){
  const box = document.getElementById('news-feed');
  list.forEach(it=>{
    const node = document.createElement('div');
    node.className = 'item';
    node.innerHTML = `
      <img src="${it.thumb}" alt="" loading="lazy">
      <div>
        <a href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
        <time datetime="${it.pubDate}">${new Date(it.pubDate).toLocaleDateString()}</time>
      </div>`;
    box.appendChild(node);
  });
}
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Allergy-World Headlines</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45;margin:0;padding:1rem}
    h1{margin:0 0 1.25rem;font-size:1.75rem}
    #news-feed{max-width:760px;margin:0 auto}
    .item{display:grid;grid-template-columns:110px 1fr;gap:.9rem;margin-bottom:1rem;align-items:start}
    .item img{width:110px;height:110px;object-fit:cover;border-radius:8px;box-shadow:0 0 4px rgba(0,0,0,.15)}
    .item a{font-weight:600;text-decoration:none;color:#053}
    .item a:hover{text-decoration:underline}
    .item time{font-size:.8rem;color:#555;display:block;margin-top:.3rem}
  </style>
</head>
<body>

<h1>Latest Allergy News</h1>
<div id="news-feed"></div>

<script>
/* ——— CONFIG ——— */
const API_KEY = 'nnzvu8zozr6k48xr7up6386y0xreoghpdp0evyfx';   // your rss2json key
const FEEDS   = [
  'https://www.fda.gov/about-fda/contact-fda/stay-informed/rss-feeds/food-allergies/rss.xml',
  'https://www.fda.gov/about-fda/contact-fda/stay-informed/rss-feeds/food-safety-recalls/rss.xml',
  'https://www.sciencedaily.com/rss/health_medicine/allergy.xml',
  'https://news.google.com/rss/search?q=allergy+OR+food+allergy&hl=en-US&gl=US&ceid=US:en'
];
const PLACEHOLDER = 'https://placehold.co/110x110?text=EPI';

/* ——— MAIN ——— */
(async ()=>{
  const makeUrl = u=>{
    const base = 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(u);
    return `${base}&api_key=${API_KEY}&count=20`;
  };

  const results = await Promise.allSettled(
    FEEDS.map(src => fetch(makeUrl(src)).then(r => r.json()))
  );

  const items = results
      .filter(r=>r.status==='fulfilled' && r.value.status==='ok')
      .flatMap(r=>r.value.items);

  items.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
  render(items.slice(0,30));
})();

/* ——— RENDER ——— */
function render(list){
  const wrap = document.getElementById('news-feed');
  list.forEach(it=>{
    const imgUrl = getImage(it) || PLACEHOLDER;
    console.log('Picked image →', imgUrl, 'for', it.title);   // DEBUG line
    const node = document.createElement('div');
    node.className='item';
    node.innerHTML=`
      <img src="${imgUrl}" alt="" loading="lazy">
      <div>
        <a href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
        <time datetime="${it.pubDate}">${new Date(it.pubDate).toLocaleDateString()}</time>
      </div>`;
    wrap.appendChild(node);
  });
}

/* ——— IMAGE PICKER ——— */
function getImage(it){
  // rss2json "thumbnail" field
  if (it.thumbnail) return fix(it.thumbnail);

  // common <enclosure> object
  if (it.enclosure && (it.enclosure.link || it.enclosure.url))
      return fix(it.enclosure.link || it.enclosure.url);

  // sometimes rss2json flattens media:content as "enclosure_link"
  if (it.enclosure_link) return fix(it.enclosure_link);

  // raw <media:content> stored as literal key
  if (it['media:content'] && it['media:content'].url)
      return fix(it['media:content'].url);

  // first <img> in description/content
  const html = it.content || it.description || '';
  const found = html.match(/<img[^>]+src=['"]([^'"]+)['"]/i);
  if (found) return fix(found[1]);

  return null;
}

/* ——— force HTTPS where possible ——— */
function fix(url=''){
  try{
    return url.startsWith('http://') ? url.replace('http://','https://') : url;
  }catch(e){
    return url;
  }
}
</script>

</body>
</html>

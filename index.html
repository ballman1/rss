<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Allergy-World Headlines</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:1rem;line-height:1.45}
    h1{margin:0 0 1.25rem;font-size:1.75rem}
    #news-feed{max-width:780px;margin:0 auto}
    .item{display:grid;grid-template-columns:112px 1fr;gap:.9rem;margin-bottom:1rem;align-items:start}
    .item img{width:112px;height:112px;object-fit:cover;border-radius:8px;box-shadow:0 0 4px rgba(0,0,0,.15)}
    .item a{font-weight:600;text-decoration:none;color:#064}
    .item a:hover{text-decoration:underline}
    .item time{display:block;font-size:.8rem;color:#666;margin-top:.3rem}
  </style>
</head>
<body>

<h1>Latest Allergy News</h1>
<div id="news-feed"></div>

<script>
/* ————— CONFIG ————— */
const RSS_KEY   = 'nnzvu8zozr6k48xr7up6386y0xreoghpdp0evyfx';                 // ← rss2json key
const FEEDS     = [
  'https://www.fda.gov/about-fda/contact-fda/stay-informed/rss-feeds/food-allergies/rss.xml',
  'https://www.fda.gov/about-fda/contact-fda/stay-informed/rss-feeds/food-safety-recalls/rss.xml',
  'https://www.sciencedaily.com/rss/health_medicine/allergy.xml',
  'https://news.google.com/rss/search?q=allergy+OR+food+allergy&hl=en-US&gl=US&ceid=US:en'
];
const PLACEHOLDER = 'https://placehold.co/112x112?text=EPI';
const MAX_ITEMS   = 30;
const MICROLINK   = url => `https://api.microlink.io/?url=${encodeURIComponent(url)}&meta=true&audio=false&video=false`;

/* ————— MAIN ————— */
(async () => {
  const rssURL = u => `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(u)}&api_key=${RSS_KEY}&count=20`;

  const arrays = await Promise.allSettled(FEEDS.map(f => fetch(rssURL(f)).then(r => r.json())));
  const items  = arrays
    .filter(r => r.status === 'fulfilled' && r.value.status === 'ok')
    .flatMap(r => r.value.items);

  items.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));

  const enriched = await Promise.all(
    items.slice(0, MAX_ITEMS).map(async it => {
      let thumb = extractImage(it);
      if (!thumb) {
        const realURL = unwrapGoogle(it.link);
        try {
          const res  = await fetch(MICROLINK(realURL));
          const data = await res.json();
          thumb = data?.data?.image?.url || '';
        } catch {/* ignore */}
      }
      return { ...it, thumb: thumb || PLACEHOLDER };
    })
  );

  render(enriched);
})();

/* ————— IMAGE PICKER ————— */
function extractImage(it){
  // 1) explicit thumbnail
  if (it.thumbnail) return fix(it.thumbnail);

  // 2) <media:thumbnail> (Google puts the hero here)
  if (it['media:thumbnail']?.url) return fix(it['media:thumbnail'].url);

  // 3) enclosure
  if (it.enclosure?.url || it.enclosure?.link) return fix(it.enclosure.url || it.enclosure.link);

  // 4) <media:content>
  if (it['media:content']?.url) return fix(it['media:content'].url);

  // 5) first <img src|data-src>… inside description/content
  const html = it.content || it.description || '';
  const m = html.match(/<img[^>]+(?:src|data-src)=['"]([^'"]+)['"]/i);
  return m ? fix(m[1]) : '';
}

/* ————— UTILITIES ————— */
function unwrapGoogle(u=''){
  // If it's a Google News redirect, try to pull ?url=… out
  if (/https?:\/\/news\.google\.com/.test(u) && u.includes('url=')){
    const real = decodeURIComponent(u.split('url=')[1].split('&')[0]);
    return real.startsWith('http') ? real : u;
  }
  return u;
}

function fix(u=''){
  if (!u) return '';
  if (u.startsWith('//'))      return 'https:' + u;
  if (u.startsWith('http://')) return u.replace('http://','https://');
  return u;
}

/* ————— RENDER ————— */
function render(list){
  const box = document.getElementById('news-feed');
  list.forEach
